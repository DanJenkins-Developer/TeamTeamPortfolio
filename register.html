<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/assets/css/styles.css" />
    <title>Register Page</title>
</head>

<body class="registration-page">

    <div class="topnav">
        <a href="index.html">Home</a>
        <a href="profile.html" class="active">Profile</a>
        <a href="#donate">Donate</a>
        <!-- <img src="assets/img/FO3_Nuka-Cola_Quantum.webp" alt="Team Quantum" class="topnav-logo" /> -->
    </div>
    <div id="registration-container">
        <h2>Enter Account Information</h2>
        <form id="account-form">
            <div class="form-group">
                <label id="register-label" for="first-name">First Name:</label>
                <input type="text" id="first-name" name="first_name" required>
            </div>
            <div class="form-group">
                <label id="register-label" for="last-name">Last Name:</label>
                <input type="text" id="last-name" name="last_name" required>
            </div>
            <div class="form-group">
                <label id="register-label" for="phone-number">Phone Number:</label>
                <input type="text" id="phone-number" name="phone_number" required>
            </div>
            <div class="form-group">
                <label id="register-label" for="photo">Upload Photograph:</label>
                <input type="file" id="photo" name="photo">
                <img src="/assets/img/FO3_Nuka-Cola_Quantum.webp" alt="Profile Picture"
                    class="register-page-profile-pic" id="profile-pic">
            </div>
            <div class="form-group">
                <label id="register-label" for="email">Email:</label>
                <input type="email" id="email" name="email" required> <!-- Corrected the type for email -->
            </div>
            <div class="form-group">
                <label id="register-label" for="password">password:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit" class="register-page-btn">Register</button>
        </form>
    </div>

    <script>
        const photoInput = document.getElementById("photo");
        const profilePic = document.getElementById("profile-pic");

        photoInput.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    profilePic.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        const accountForm = document.getElementById("account-form");

        accountForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            console.log("Form Data:", formData);



            fetch('http://127.0.0.1:8000/register', {

                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        // If the response is not ok, we'll handle it as an error
                        return Promise.reject(response);
                    }
                    return response.json(); // Parse the JSON if response is ok
                })
                .then(data => {

                    const current_user = data

                    console.log(current_user)
                    console.log(current_user.access_token)

                    localStorage.setItem("token", current_user.access_token)
                    localStorage.setItem("current_user", JSON.stringify(current_user))

                    console.log(localStorage.getItem("current_user"))

                    window.location.href = "profile.html"; // Redirect to the user's profile

                    // if (data.access_token) {
                    //     localStorage.setItem('token', data.access_token)
                    //     window.location.href = "profile.html"; // Redirect to the desired URL
                    // }
                })
                .catch(error => {
                    if (error instanceof Response) {
                        // Check if error is an instance of Response
                        error.json().then(body => {
                            if (error.status === 422) {
                                // Handle the specific 422 error
                                console.error('Validation Error:', body);
                                // Display the validation message to the user
                                alert(body.detail[0].msg);
                            } else {
                                // Handle other HTTP errors
                                console.error('HTTP Error:', body);
                                alert("An error occurred: " + body.detail || "Something went wrong. Please try again later.");
                            }
                        });
                    } else {
                        // Handle non-HTTP errors (network error, etc.)
                        console.error('Network or other error:', error);
                        alert("Something went wrong. Please try again later.");
                    }
                });
        });
    </script>
</body>

</html>